{"version":3,"sources":["zombie/resources.js"],"names":[],"mappings":"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","file":"zombie/resources.js","sourcesContent":["// Retrieve resources (HTML pages, scripts, XHR, etc).\n//\n// If count is unspecified, defaults to at least one.\n//\n// Each browser has a resources objects that allows you to:\n// - Inspect the history of retrieved resources, useful for troubleshooting\n//   issues related to resource loading\n// - Simulate a failed server\n// - Change the order in which resources are retrieved, or otherwise introduce\n//   delays to simulate a real world network\n// - Mock responses from servers you don't have access to, or don't want to\n//   access from test environment\n// - Request resources directly, but have Zombie handle cookies,\n//   authentication, etc\n// - Implement new mechanism for retrieving resources, for example, add new\n//   protocols or support new headers\n\n\nconst iconv       = require('iconv-lite');\nconst File        = require('fs');\nconst DOM         = require('./dom');\nconst Path        = require('path');\nconst QS          = require('querystring');\nconst Request     = require('request');\nconst URL         = require('url');\nconst HTTP        = require('http');\nconst Zlib        = require('zlib');\nconst assert      = require('assert');\nconst { Promise } = require('bluebird');\n\n\n// Each browser has a resources object that provides the means for retrieving\n// resources and a list of all retrieved resources.\n//\n// The object is an array, and its elements are the resources.\nclass Resources extends Array {\n\n  constructor(browser) {\n    this.browser      = browser;\n    this.pipeline     = Resources.pipeline.slice();\n    this.urlMatchers  = [];\n  }\n\n\n  // Make an HTTP request (also supports file: protocol).\n  //\n  // method    - Request method (GET, POST, etc)\n  // url       - Request URL\n  // options   - See below\n  // callback  - Called with error, or null and response\n  //\n  // Without callback, returns a promise.\n  //\n  // Options:\n  //   headers   - Name/value pairs of headers to send in request\n  //   params    - Parameters to pass in query string or document body\n  //   body      - Request document body\n  //   timeout   - Request timeout in milliseconds (0 or null for no timeout)\n  //\n  // Response contains:\n  //   url         - Actual resource URL (changed by redirects)\n  //   statusCode  - Status code\n  //   statusText  - HTTP status text (\"OK\", \"Not Found\" etc)\n  //   headers     - Response headers\n  //   body        - Response body\n  //   redirects   - Number of redirects followed\n  request(method, url, options = {}, callback = null) {\n    if (!callback && typeof(options) === 'function')\n      [options, callback] = [{}, options];\n\n    const request = {\n      method:     method.toUpperCase(),\n      url:        url,\n      headers:    options.headers || {},\n      params:     options.params,\n      body:       options.body,\n      time:       Date.now(),\n      timeout:    options.timeout || 0,\n      strictSSL:  this.browser.strictSSL,\n      localAddress: this.browser.localAddress || 0\n    };\n\n    const resource = {\n      request:    request,\n      target:     options.target\n    };\n    this.push(resource);\n    this.browser.emit('request', request);\n\n    const promise = new Promise((resolve, reject)=> {\n      this.runPipeline(request, (error, response)=> {\n        if (error) {\n          resource.error = error;\n          reject(error);\n        } else {\n          response.url        = response.url || request.url;\n          response.statusCode = response.statusCode || 200;\n          response.statusText = HTTP.STATUS_CODES[response.statusCode] || 'Unknown';\n          response.headers    = response.headers || {};\n          response.redirects  = response.redirects || 0;\n          response.time       = Date.now();\n          resource.response = response;\n\n          this.browser.emit('response', request, response);\n          resolve(resource.response);\n        }\n      });\n    });\n\n    if (callback) {\n      promise.done((response)=> callback(null, response), callback);\n    } else\n      return promise;\n  }\n\n\n  // GET request.\n  //\n  // url       - Request URL\n  // options   - See request() method\n  // callback  - Called with error, or null and response\n  get(url, options, callback) {\n    return this.request('get', url, options, callback);\n  }\n\n  // POST request.\n  //\n  // url       - Request URL\n  // options   - See request() method\n  // callback  - Called with error, or null and response\n  post(url, options, callback) {\n    return this.request('post', url, options, callback);\n  }\n\n\n  // You can use this to make a request to a given URL fail.\n  //\n  // url     - URL to fail\n  // message - Optional error message\n  fail(url, message) {\n    function failTheRequest(request, next) {\n      next(new Error(message || 'This request was intended to fail'));\n    }\n    this.urlMatchers.push([url, failTheRequest]);\n    return this;\n  }\n\n  // You can use this to delay a response from a given URL.\n  //\n  // url   - URL to delay\n  // delay - Delay in milliseconds (defaults to 10)\n  delay(url, delay = 10) {\n    function delayTheResponse(request, next) {\n      setTimeout(next, delay);\n    }\n    this.urlMatchers.push([url, delayTheResponse]);\n    return this;\n  }\n\n  // You can use this to return a particular result for a given URL.\n  //\n  // url     - The URL to mock\n  // result  - The result to return (statusCode, headers, body)\n  mock(url, result = {}) {\n    function mockTheResponse(request, next) {\n      next(null, result);\n    }\n    this.urlMatchers.push([url, mockTheResponse]);\n    return this;\n  }\n\n  // You can use this to restore default behavior to after using fail, delay or\n  // mock.\n  restore(url) {\n    this.urlMatchers = this.urlMatchers\n      .filter(([match])=> match !== url);\n    return this;\n  }\n\n\n  // Human readable resource listing.  With no arguments, write it to stdout.\n  dump(output = process.stdout) {\n    for (let resource of this) {\n      const { request, response, error, target } = resource;\n      // Write summary request/response header\n      if (response)\n        output.write(`${request.method} ${response.url} - ${response.statusCode} ${response.statusText} - ${response.time - request.time}ms\\n`);\n      else\n        output.write(`${resource.request.method} ${resource.request.url}\\n`);\n\n      // Tell us which element/document is loading this.\n      if (target instanceof DOM.Document) {\n        output.write('  Loaded as HTML document\\n');\n      } else if (target) {\n        if (target.id)\n          output.write(`  Loading by element #${target.id}\\n`);\n        else\n          output.write(`  Loading as ${target.tagName} element\\n`);\n      }\n\n      // If response, write out response headers and sample of document entity\n      // If error, write out the error message\n      // Otherwise, indicate this is a pending request\n      if (response) {\n        if (response.redirects)\n          output.write(`  Followed ${response.redirects} redirects\\n`);\n        for (let name in response.headers) {\n          let value = response.headers[name];\n          output.write(`  ${name}: ${value}\\n`);\n        }\n        output.write('\\n');\n        const sample = response.body\n          .slice(0, 250)\n          .toString('utf8')\n          .split('\\n')\n          .map(line => `  ${line}`).join('\\n');\n        output.write(sample);\n      } else if (error) {\n        output.write(`  Error: ${error.message}\\n`);\n      } else\n        output.write(`  Pending since ${new Date(request.time)}\\n`);\n      // Keep them separated\n      output.write('\\n\\n');\n    }\n  }\n\n\n  // Add a request/response handler.  This handler will only be used by this\n  // browser.\n  addHandler(handler) {\n    assert(handler.call, 'Handler must be a function');\n    assert(handler.length === 2 || handler.length === 3, 'Handler function takes 2 (request handler) or 3 (reponse handler) arguments');\n    this.pipeline.push(handler);\n  }\n\n  // Processes the request using the pipeline.\n  runPipeline(request, callback) {\n    const { browser } = this;\n    const requestHandlers = this.pipeline\n      .filter(fn => fn.length === 2)\n      .concat(Resources.makeHTTPRequest);\n    const responseHandlers = this.pipeline\n      .filter(fn => fn.length === 3);\n\n    let response = null;\n    // Called to execute the next request handler.\n    function nextRequestHandler(error, responseFromHandler) {\n      if (error) {\n        callback(error);\n      } else if (responseFromHandler) {\n        // Received response, switch to processing request\n        response = responseFromHandler;\n        // If we get redirected and the final handler doesn't provide a URL (e.g.\n        // mock response), then without this we end up with the original URL.\n        response.url = response.url || request.url;\n        nextResponseHandler();\n      } else {\n        // Use the next request handler.\n        const handler = requestHandlers.shift();\n        try {\n          handler.call(browser, request, nextRequestHandler);\n        } catch (error) {\n          callback(error);\n        }\n      }\n    }\n\n    // Called to execute the next response handler.\n    function nextResponseHandler(error, responseFromHandler) {\n      if (error) {\n        callback(error);\n      } else {\n        if (responseFromHandler)\n          response = responseFromHandler;\n        const handler = responseHandlers.shift();\n        if (handler) {\n          // Use the next response handler\n          try {\n            handler.call(browser, request, response, nextResponseHandler);\n          } catch (error) {\n            callback(error);\n          }\n        } else {\n          // No more handlers, callback with response.\n          callback(null, response);\n        }\n      }\n    }\n\n    // Start with first request handler\n    nextRequestHandler();\n  }\n\n}\n\n\n\n// -- Handlers\n\n// Add a request/response handler.  This handler will be used in all browsers.\nResources.addHandler = function(handler) {\n  assert(handler.call, 'Handler must be a function');\n  assert(handler.length === 2 || handler.length === 3, 'Handler function takes 2 (request handler) or 3 (response handler) arguments');\n  this.pipeline.push(handler);\n};\n\n\n// This handler normalizes the request URL.\n//\n// It turns relative URLs into absolute URLs based on the current document URL\n// or base element, or if no document open, based on browser.site property.\n//\n// Also handles file: URLs and creates query string from request.params for\n// GET/HEAD/DELETE requests.\nResources.normalizeURL = function(request, next) {\n  if (/^file:/.test(request.url)) {\n    // File URLs are special, need to handle missing slashes and not attempt\n    // to parse (downcases path)\n    request.url = request.url.replace(/^file:\\/{1,3}/, 'file:///');\n  } else {\n    // Resolve URL relative to document URL/base, or for new browser, using\n    // Browser.site\n    if (this.document)\n      request.url = DOM.resourceLoader.resolve(this.document, request.url);\n    else\n      request.url = URL.resolve(this.site || 'http://localhost', request.url);\n  }\n\n  if (request.params) {\n    const { method } = request;\n    if (method === 'GET' || method === 'HEAD' || method === 'DELETE') {\n      // These methods use query string parameters instead\n      const uri = URL.parse(request.url, true);\n      Object.assign(uri.query, request.params);\n      request.url = URL.format(uri);\n    }\n  }\n\n  next();\n};\n\n\n// This handler mergers request headers.\n//\n// It combines headers provided in the request with custom headers defined by\n// the browser (user agent, authentication, etc).\n//\n// It also normalizes all headers by down-casing the header names.\nResources.mergeHeaders = function(request, next) {\n  // Header names are down-cased and over-ride default\n  const headers = {\n    'user-agent':       this.userAgent\n  };\n\n  // Merge custom headers from browser first, followed by request.\n  for (let name in this.headers) {\n    headers[name.toLowerCase()] = this.headers[name];\n  }\n  if (request.headers) {\n    for (let name in request.headers)\n      headers[name.toLowerCase()] = request.headers[name];\n  }\n\n  const { host } = URL.parse(request.url);\n\n  // Depends on URL, don't allow over-ride.\n  headers.host = host;\n\n  // Apply authentication credentials\n  const credentials = this.authenticate(host, false);\n  if (credentials)\n    credentials.apply(headers);\n\n  request.headers = headers;\n  next();\n};\n\n\n// Depending on the content type, this handler will create a request body from\n// request.params, set request.multipart for uploads.\nResources.createBody = function(request, next) {\n  const { method } = request;\n  if (method !== 'POST' && method !== 'PUT') {\n    next();\n    return;\n  }\n\n  const { headers } = request;\n  // These methods support document body.  Create body or multipart.\n  headers['content-type'] = headers['content-type'] || 'application/x-www-form-urlencoded';\n  const mimeType = headers['content-type'].split(';')[0];\n  if (request.body) {\n    next();\n    return;\n  }\n\n  const params = request.params || {};\n  switch (mimeType) {\n    case 'application/x-www-form-urlencoded': {\n      request.body = QS.stringify(params);\n      headers['content-length'] = request.body.length;\n      next();\n      break;\n    }\n\n    case 'multipart/form-data': {\n      if (Object.keys(params).length === 0) {\n        // Empty parameters, can't use multipart\n        headers['content-type'] = 'text/plain';\n        request.body = '';\n      } else {\n\n        const boundary = `${new Date().getTime()}.${Math.random()}`;\n        headers['content-type'] += `; boundary=${boundary}`;\n        request.multipart = Object.keys(params)\n          .reduce((parts, name)=> {\n            const values = params[name]\n              .map(value => formData(name, value) );\n            return parts.concat(values);\n          }, []);\n      }\n      next();\n      break;\n    }\n\n    case 'text/plain': {\n      // XHR requests use this by default\n      next();\n      break;\n    }\n\n    default: {\n      next(new Error(`Unsupported content type ${mimeType}`));\n      break;\n    }\n  }\n};\n\nfunction formData(name, value) {\n  if (value.read) {\n    const buffer = value.read();\n    return {\n      'Content-Disposition':  `form-data; name=\\\"${name}\\\"; filename=\\\"${value}\\\"`,\n      'Content-Type':         value.mime || 'application/octet-stream',\n      'Content-Length':       buffer.length,\n      body:                   buffer\n    };\n  } else {\n    return {\n      'Content-Disposition':  `form-data; name=\\\"${name}\\\"`,\n      'Content-Type':         'text/plain; charset=utf8',\n      'Content-Length':       value.length,\n      body:                   value\n    };\n  }\n}\n\n\n// Special URL handlers can be used to fail or delay a request, or mock a\n// response.\nResources.specialURLHandlers = function(request, next) {\n  for (let [url, handler] of this.resources.urlMatchers) {\n    if (url instanceof RegExp) {\n      if (url.test(request.url)) {\n        handler(request, next);\n        return;\n      }\n    } else if (URL.resolve(request.url, url) === request.url) {\n      handler(request, next);\n      return;\n    }\n  }\n  next();\n};\n\n\nResources.handleHTTPResponse = function(request, response, next) {\n  response.headers = response.headers || {};\n\n  const { protocol, hostname, pathname } = URL.parse(request.url);\n  if (protocol !== 'http:' && protocol !== 'https:') {\n    next();\n    return;\n  }\n\n  // Set cookies from response\n  const setCookie = response.headers['set-cookie'];\n  if (setCookie)\n    this.cookies.update(setCookie, hostname, pathname);\n\n  // Number of redirects so far.\n  let redirects   = request.redirects || 0;\n  let redirectUrl = null;\n\n  // Determine whether to automatically redirect and which method to use\n  // based on the status code\n  const { statusCode } = response;\n  if (statusCode === 301 || statusCode === 307) {\n    // Do not follow POST redirects automatically, only GET/HEAD\n    if (request.method === 'GET' || request.method === 'HEAD')\n      redirectUrl = URL.resolve(request.url, response.headers.location);\n  } else if (statusCode === 302 || statusCode === 303) {\n    // Follow redirect using GET (e.g. after form submission)\n    redirectUrl = URL.resolve(request.url, response.headers.location);\n  }\n\n  if (redirectUrl) {\n\n    response.url = redirectUrl;\n    // Handle redirection, make sure we're not caught in an infinite loop\n    ++redirects;\n    if (redirects > this.maxRedirects) {\n      next(new Error(`More than ${this.maxRedirects} redirects, giving up`));\n      return;\n    }\n\n    const redirectHeaders = Object.assign({}, request.headers);\n    // This request is referer for next\n    redirectHeaders.referer = request.url;\n    // These headers exist in POST request, do not pass to redirect (GET)\n    delete redirectHeaders['content-type'];\n    delete redirectHeaders['content-length'];\n    delete redirectHeaders['content-transfer-encoding'];\n    // Redirect must follow the entire chain of handlers.\n    const redirectRequest = {\n      method:     'GET',\n      url:        response.url,\n      headers:    redirectHeaders,\n      redirects:  redirects,\n      strictSSL:  request.strictSSL,\n      time:       request.time,\n      timeout:    request.timeout\n    };\n    this.emit('redirect', request, response, redirectRequest);\n    this.resources.runPipeline(redirectRequest, next);\n\n  } else {\n    response.redirects = redirects;\n    next();\n  }\n};\n\n\n// Handle deflate and gzip transfer encoding.\nResources.decompressBody = function(request, response, next) {\n  const transferEncoding  = response.headers['transfer-encoding'];\n  const contentEncoding   = response.headers['content-encoding'];\n  if (contentEncoding === 'deflate' || transferEncoding === 'deflate') {\n    Zlib.inflate(response.body, (error, buffer)=> {\n      response.body = buffer;\n      next(error);\n    });\n  }\n  else if (contentEncoding === 'gzip' || transferEncoding === 'gzip') {\n    Zlib.gunzip(response.body, (error, buffer)=> {\n      response.body = buffer;\n      next(error);\n    });\n  } else\n    next();\n};\n\n\n// Find the charset= value of the meta tag\nconst MATCH_CHARSET = /<meta(?!\\s*(?:name|value)\\s*=)[^>]*?charset\\s*=[\\s\"']*([^\\s\"'\\/>]*)/i;\n\n// This handler decodes the response body based on the response content type.\nResources.decodeBody = function(request, response, next) {\n  if (!Buffer.isBuffer(response.body)) {\n    next();\n    return;\n  }\n\n  // If Content-Type header specifies charset, use that\n  const contentType = response.headers['content-type'] || 'application/unknown';\n  const [mimeType, ...typeOptions]  = contentType.split(/;\\s*/);\n  const [type, subtype]             = contentType.split(/\\//,2);\n\n  // Images, binary, etc keep response body a buffer\n  if (type && type !== 'text') {\n    next();\n    return;\n  }\n\n  let charset = null;\n\n  // Pick charset from content type\n  if (mimeType) {\n    for (let typeOption of typeOptions) {\n      if (/^charset=/i.test(typeOption)) {\n        charset = typeOption.split('=')[1];\n        break;\n      }\n    }\n  }\n\n  // Otherwise, HTML documents only, pick charset from meta tag\n  // Otherwise, HTML documents only, default charset in US is windows-1252\n  const isHTML = /html/.test(subtype) || /\\bhtml\\b/.test(request.headers.accept);\n  if (!charset && isHTML) {\n    const match = response.body.toString().match(MATCH_CHARSET);\n    charset = match ? match[1] : 'windows-1252';\n  }\n\n  if (charset)\n    response.body = iconv.decode(response.body, charset);\n  next();\n};\n\n\n// All browsers start out with this list of handler.\nResources.pipeline = [\n  Resources.normalizeURL,\n  Resources.mergeHeaders,\n  Resources.createBody,\n  Resources.specialURLHandlers,\n  Resources.handleHTTPResponse,\n  Resources.decompressBody,\n  Resources.decodeBody\n];\n\n\n// -- Make HTTP request\n\n\n// Used to perform HTTP request (also supports file: resources).  This is always\n// the last request handler.\nResources.makeHTTPRequest = function(request, callback) {\n  const { protocol, hostname, pathname } = URL.parse(request.url);\n  if (protocol === 'file:') {\n\n    // If the request is for a file:// descriptor, just open directly from the\n    // file system rather than getting node's http (which handles file://\n    // poorly) involved.\n    if (request.method !== 'GET') {\n      callback(null, { statusCode: 405 });\n      return;\n    }\n\n    const filename = Path.normalize(decodeURI(pathname));\n    File.exists(filename, function(exists) {\n      if (exists) {\n        File.readFile(filename, function(error, buffer) {\n          // Fallback with error -> callback\n          if (error) {\n            request.error = error;\n            callback(error);\n          } else\n            callback(null, { body: buffer });\n        });\n      } else\n        callback(null, { statusCode: 404 });\n    });\n\n  } else {\n\n    // We're going to use cookies later when recieving response.\n    const { cookies } = this;\n    request.headers.cookie = cookies.serialize(hostname, pathname);\n\n    const httpRequest = {\n      method:         request.method,\n      url:            request.url,\n      headers:        request.headers,\n      body:           request.body,\n      multipart:      request.multipart,\n      proxy:          this.proxy,\n      jar:            false,\n      followRedirect: false,\n      encoding:       null,\n      strictSSL:      request.strictSSL,\n      localAddress:   request.localAddress || 0,\n      timeout:        request.timeout || 0\n    };\n\n    Request(httpRequest, function(error, response) {\n      if (error) {\n        callback(error);\n      } else {\n        callback(null, {\n          url:          request.url,\n          statusCode:   response.statusCode,\n          headers:      response.headers,\n          body:         response.body,\n          redirects:    request.redirects || 0\n        });\n      }\n    });\n\n\n  }\n\n};\n\n\nmodule.exports = Resources;\n\n"],"sourceRoot":"/source/"}